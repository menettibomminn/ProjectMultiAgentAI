name: Multi-Agent CI

on:
  push:
    paths:
      - "Agents/**"
      - "Controller/**"
      - "Orchestrator/**"
      - "pyproject.toml"
      - ".github/workflows/ci.yml"
  pull_request:
    paths:
      - "Agents/**"
      - "Controller/**"
      - "Orchestrator/**"
      - "pyproject.toml"

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11"]
        agent:
          - name: sheets_agent
            path: Agents/sheets_agent
            requirements: Agents/sheets_agent/requirements.txt
            tests: Agents/sheets_agent/tests/
            src: Agents/sheets_agent/
          - name: auth_agent
            path: Agents/auth_agent
            requirements: Agents/auth_agent/requirements.txt
            tests: Agents/auth_agent/tests/
            src: Agents/auth_agent/
          - name: backend_agent
            path: Agents/backend_agent
            requirements: Agents/backend_agent/requirements.txt
            tests: Agents/backend_agent/tests/
            src: Agents/backend_agent/
          - name: frontend_agent
            path: Agents/frontend_agent
            requirements: Agents/frontend_agent/requirements.txt
            tests: Agents/frontend_agent/tests/
            src: Agents/frontend_agent/
          - name: metrics_agent
            path: Agents/metrics_agent
            requirements: Agents/metrics_agent/requirements.txt
            tests: Agents/metrics_agent/tests/
            src: Agents/metrics_agent/
          - name: controller
            path: Controller
            requirements: Controller/requirements.txt
            tests: Controller/tests/
            src: Controller/
          - name: orchestrator
            path: Orchestrator
            requirements: Controller/requirements.txt
            tests: Orchestrator/tests/
            src: Orchestrator/

    name: "${{ matrix.agent.name }} (py${{ matrix.python-version }})"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r ${{ matrix.agent.requirements }}

      - name: Lint with flake8
        run: |
          flake8 ${{ matrix.agent.src }} --max-line-length=100 --exclude=__pycache__

      - name: Type check with mypy (strict)
        run: |
          mypy ${{ matrix.agent.src }} --exclude tests

      - name: Run tests
        run: |
          python -m pytest ${{ matrix.agent.tests }} -v --tb=short

  integration:
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        python-version: ["3.10", "3.11"]

    name: "integration (py${{ matrix.python-version }})"

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install all dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Agents/sheets_agent/requirements.txt
          pip install -r Controller/requirements.txt

      - name: Run integration tests
        run: |
          python -m pytest Controller/tests/test_integration.py -v --tb=short
